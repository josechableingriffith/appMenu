---
import Layout from "../layouts/layout.astro";
import { supabase } from '../lib/supabase.js';

let { data: todosLosIngredientes } = await supabase
    .from('ingredientes')
    .select('*')
    .order('nombre', { ascending: true });

const ingredientesAgrupados = todosLosIngredientes?.reduce((acc, ing) => {
  const tienda = ing.tienda || 'Sin Tienda';
  const depto = ing.departamento || 'Sin Departamento';
  if (!acc[tienda]) acc[tienda] = {};
  if (!acc[tienda][depto]) acc[tienda][depto] = [];
  acc[tienda][depto].push(ing);
  return acc;
}, {});

const departamentos = ["Frutas y Verduras", "Carnes", "Lácteos", "Abarrotes", "Limpieza", "Congelados", "Panadería"];
const tiendas = ["Lidl", "Tesco", "Aldi", "Dunnes", "Otra"];
---

<Layout title="Lista de ingredientes">
  <div class="mx-5">
    <h1 class="mb-4 text-4xl font-bold tracking-tight text-heading md:text-5xl lg:text-6xl">Lista de ingredientes</h1>
    <p class="mb-6 text-lg font-normal text-body lg:text-xl sm:px-16 xl:px-48">Esto es para que pongamos una descripción a nuestra app mi amor.</p>
  </div>

{ingredientesAgrupados && Object.keys(ingredientesAgrupados).map((tienda) => (
  <div class="mb-10">
    <h2 class="text-3xl font-bold text-heading mx-7 my-5">{tienda}</h2>
    <div class="bg-neutral-primary-soft shadow-xs rounded-base border border-default mx-5 overflow-hidden">
      {Object.keys(ingredientesAgrupados[tienda]).map((depto) => (
        <div class="border-b border-default last:border-none">
          <div class="px-6 py-2 bg-neutral-secondary-medium font-bold text-body uppercase text-[10px] tracking-widest border-b border-default">
            {depto}
          </div>
          <table class="w-full text-sm text-left text-body">
            <tbody class="divide-y divide-default">
              {ingredientesAgrupados[tienda][depto].map((ingrediente) => (
                <tr class="hover:bg-neutral-secondary-soft transition-colors">
                  <td class="px-6 py-4 font-medium text-heading w-1/2">{ingrediente.nombre}</td>
                  <td class="px-6 py-4 w-1/4">$ {ingrediente.precio}</td>
                  <td class="px-6 py-4 text-right w-1/4">
                    <button 
                      type="button" 
                      data-modal-target="up-modal" 
                      data-modal-toggle="up-modal" 
                      class="edit-btn font-medium text-fg-brand hover:underline" 
                      data-ingrediente={JSON.stringify(ingrediente)}
                    >
                      Editar
                    </button>
                  </td> 
                </tr>
              ))}
            </tbody>
          </table>
        </div>
      ))}
    </div>
  </div>
))}

<div id="up-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 justify-center items-center w-full h-full bg-gray-900/50 backdrop-blur-sm">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-neutral-primary-soft border border-default rounded-base shadow-lg">
            <div class="flex items-center justify-between border-b border-default p-4">
                <h3 class="text-lg font-medium text-heading">Actualizar ingrediente</h3>
                <button type="button" class="text-body hover:bg-neutral-tertiary rounded-base text-sm w-8 h-8 inline-flex justify-center items-center" data-modal-hide="up-modal">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                </button>
            </div>
            <form action="/api/actualizar-ingrediente" method="post" class="p-6">
                <input type="hidden" name="id" id="up-id" />
                <div class="grid gap-4 grid-cols-2">
                    <div class="col-span-2">
                        <label class="block mb-2 text-sm font-medium">Nombre</label>
                        <input type="text" name="nombre" id="up-nombre" class="w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base focus:ring-brand focus:border-brand" required>
                    </div>
                    <div class="col-span-1">
                        <label class="block mb-2 text-sm font-medium">Precio</label>
                        <input type="number" step="0.01" name="precio" id="up-precio" class="w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base" required>
                    </div>
                    <div class="col-span-1">
                        <label class="block mb-2 text-sm font-medium">Departamento</label>
                        <select name="departamento" id="up-departamento" class="w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base">
                            {departamentos.map(d => <option value={d}>{d}</option>)}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block mb-2 text-sm font-medium">Tienda</label>
                        <select name="tienda" id="up-tienda" class="w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base">
                            {tiendas.map(t => <option value={t}>{t}</option>)}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <div class="flex items-center ps-4 border border-default rounded-base">
                            <input type="checkbox" name="es_porcionable" id="up-es_porcionable" value="true" class="w-4 h-4 text-brand bg-gray-100 border-gray-300 rounded">
                            <label for="up-es_porcionable" class="w-full py-4 ms-2 text-sm font-medium text-body">¿Es uno por comida?</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 text-white bg-brand hover:bg-brand-strong py-2.5 rounded-base font-medium">
                    Actualizar Ingrediente
                </button>
            </form>
        </div>
    </div>
</div>

<div id="crud-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 justify-center items-center w-full h-full bg-gray-900/50 backdrop-blur-sm">
    <div class="relative p-4 w-full max-w-md max-h-full">
        <div class="relative bg-neutral-primary-soft border border-default rounded-base shadow-lg">
            <div class="flex items-center justify-between border-b border-default p-4">
                <h3 class="text-lg font-medium text-heading">Nuevo ingrediente</h3>
                <button type="button" class="text-body hover:bg-neutral-tertiary rounded-base text-sm w-8 h-8 inline-flex justify-center items-center" data-modal-hide="crud-modal">
                    <svg class="w-3 h-3" fill="none" viewBox="0 0 14 14"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/></svg>
                </button>
            </div>
            <form action="/api/guardar-ingrediente" method="post" class="p-6">
                <div class="grid gap-4 grid-cols-2">
                    <div class="col-span-2">
                        <label class="block mb-2 text-sm font-medium">Nombre</label>
                        <input type="text" name="nombre" class="w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base" placeholder="Ej. Tomates" required>
                    </div>
                    <div class="col-span-1">
                        <label class="block mb-2 text-sm font-medium">Precio</label>
                        <input type="number" step="0.01" name="precio" class="w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base" placeholder="0.00" required>
                    </div>
                    <div class="col-span-1">
                        <label class="block mb-2 text-sm font-medium">Depto</label>
                        <select name="departamento" class="w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base">
                            {departamentos.map(d => <option value={d}>{d}</option>)}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <label class="block mb-2 text-sm font-medium">Tienda</label>
                        <select name="tienda" class="w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base">
                            {tiendas.map(t => <option value={t}>{t}</option>)}
                        </select>
                    </div>
                    <div class="col-span-2">
                        <div class="flex items-center ps-4 border border-default rounded-base">
                            <input type="checkbox" name="es_porcionable" id="es_porcionable" value="true" class="w-4 h-4 text-brand bg-gray-100 border-gray-300 rounded">
                            <label for="es_porcionable" class="w-full py-4 ms-2 text-sm font-medium text-body">¿Es uno por comida?</label>
                        </div>
                    </div>
                </div>
                <button type="submit" class="w-full mt-6 text-white bg-brand hover:bg-brand-strong py-2.5 rounded-base font-medium">
                    Guardar Ingrediente
                </button>
            </form>
        </div>
    </div>
</div>

<div id="toast-success" class="fixed bottom-20 right-5 flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow-lg hidden transition-opacity duration-300 z-50" role="alert">
    <div class="inline-flex items-center justify-center shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg">
        <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>
    </div>
    <div id="toast-message" class="ms-3 text-sm font-normal">Acción completada.</div>
</div>


<div class="fixed right-5 bottom-[10dvh]">
  <button data-modal-target="crud-modal" data-modal-toggle="crud-modal" class="text-white bg-brand hover:bg-brand-strong box-border border border-transparent focus:ring-4 focus:ring-brand-medium shadow-xl font-medium rounded-base text-base px-5 py-3 focus:outline-none flex" type="button">
    <span class="mr-3">Nuevo ingrediente</span>
    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/></svg>
  </button>  
</div>



<script>
  // Manejo de Toasts y Limpieza de URL
  function handleToasts() {
    const params = new URLSearchParams(window.location.search);
    const msg = params.get('msg');
    const toast = document.getElementById('toast-success');
    if (msg === 'success' && toast) {
      toast.classList.remove('hidden');
      window.history.replaceState({}, document.title, window.location.pathname);
      setTimeout(() => toast.classList.add('hidden'), 4000);
    }
  }

  // Delegación de Eventos para Edición
  function setupEditLogic() {
    document.addEventListener('click', (e) => {
      const btn = (e.target as HTMLElement).closest('.edit-btn');
      if (btn) {
        const data = JSON.parse((btn as HTMLElement).dataset.ingrediente || '{}');
        
        // Rellenar el modal de edición (IDs con prefijo up-)
        (document.getElementById('up-id') as HTMLInputElement).value = data.id;
        (document.getElementById('up-nombre') as HTMLInputElement).value = data.nombre;
        (document.getElementById('up-precio') as HTMLInputElement).value = data.precio;
        (document.getElementById('up-departamento') as HTMLSelectElement).value = data.departamento;
        (document.getElementById('up-tienda') as HTMLSelectElement).value = data.tienda;
        (document.getElementById('up-es_porcionable') as HTMLInputElement).checked = data.es_porcionable;
      }
    });
  }

  // Ejecutar en cada carga (Compatible con o sin View Transitions)
  document.addEventListener('astro:page-load', () => {
    handleToasts();
    setupEditLogic();
  });
  
  // Fallback para cuando no hay ClientRouter
  handleToasts();
  setupEditLogic();
</script>

</Layout>