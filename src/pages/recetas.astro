---
import Layout from "../layouts/layout.astro";
import { supabase } from '../lib/supabase';

// Obtenemos las recetas
const { data: recetas, error } = await supabase
  .from('recetas')
  .select('*')
  .order('platillo', { ascending: true }); // Ordena de la A a la Z

  // Agrupamos por letra inicial
const recetasAgrupadas = recetas?.reduce((acc, receta) => {
  const letra = receta.platillo.charAt(0).toUpperCase();
  if (!acc[letra]) {
    acc[letra] = [];
  }
  acc[letra].push(receta);
  return acc;
}, {});

// Obtenemos las letras ordenadas
const letras = recetasAgrupadas ? Object.keys(recetasAgrupadas).sort() : [];

if (error) console.error("Error de Supabase:", error);

// Obtenemos los ingredientes existentes para el select
const { data: ingredientesDB } = await supabase
  .from('ingredientes')
  .select('nombre')
  .order('nombre', { ascending: true });

const departamentos = ["Frutas y Verduras", "Carnes", "Lácteos", "Abarrotes", "Limpieza", "Congelados", "Panadería"];
const tiendas = ["Lidl", "Tesco", "Aldi", "Dunnes", "Otra"];
---

<Layout title="Mis Recetas">
<div class="mx-5">
	<h1 class="mb-4 text-4xl font-bold tracking-tight text-heading md:text-5xl lg:text-6xl">Lista de recetas</h1>
	<p class="mb-6 text-lg font-normal text-body lg:text-xl sm:px-16 xl:px-48">Esto es para que pongamos una descripción a nuestra app mi amor.</p>
</div>


{letras.map((letra) => (
  <section class="mb-10">
    <div class="mx-5 p-5 mb-5 border-b border-default-medium sticky top-[9dvh] z-index-0 bg-white">
      <h2 class="text-2xl font-bold text-brand">{letra}</h2>
    </div>

    <div class="space-y-5">
        {recetasAgrupadas[letra].map((receta) => (
        <div id={'accordion-card-'+receta.id} data-accordion="collapse" class="mx-5">
          <h2 >
            <button type="button" id={'accordion-card-heading-'+receta.id} class="flex items-center justify-between w-full p-5 font-medium text-body rounded-base shadow-xs border border-default gap-3 [&[aria-expanded='true']]:rounded-b-none" data-accordion-target={'#accordion-card-body-'+receta.id} aria-expanded="false">
              <span class="text-lg font-bold text-heading">{receta.platillo}</span>
              <svg data-accordion-icon class="w-5 h-5 shrink-0 transition-transform" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m5 15 7-7 7 7"/></svg>
            </button>
          </h2>
          <div id={'accordion-card-body-'+receta.id} class="hidden border border-t-0 border-default rounded-b-base bg-white" aria-labelledby={'accordion-card-heading-'+receta.id}>
            <div class="p-5">
              <h3 class="mb-3 text-sm font-bold uppercase tracking-wider text-gray-500">Ingredientes:</h3>
              <ul class="grid grid-cols-1 md:grid-cols-2 gap-2">
                {receta.ingredientes?.map((ingrediente) => (
                  <li class="flex items-center text-body">
                    <svg class="w-4 h-4 text-brand me-2" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>
                    {ingrediente}
                  </li>
                ))}
              </ul>

              {receta.nota && (
                <div class="mt-6 p-3 bg-neutral-secondary-soft rounded-base border-l-4 border-brand">
                  <h3 class="text-xs font-bold uppercase text-gray-500 mb-1">Notas:</h3>
                  <p class="text-sm text-body italic">{receta.nota}</p>
                </div>
              )}

              {receta.link && (
                <div class="mt-4">
                  <a href={receta.link} target="_blank" class="inline-flex items-center text-sm font-medium text-fg-brand hover:underline">
                    {receta.link} 
                    <svg class="w-4 h-4 ms-2" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M18 14v4.833A1.166 1.166 0 0 1 16.833 20H5.167A1.167 1.167 0 0 1 4 18.833V7.167A1.166 1.166 0 0 1 5.167 6h4.618m4.447-2H20v5.768m-7.889 2.121 7.778-7.778"/></svg>
                  </a>
                </div>
              )}
            </div>
            <div class="flex justify-end border-t border-default px-5 py-3">
              <button 
                type="button" 
                data-modal-target="edit-receta-modal" 
                data-modal-toggle="edit-receta-modal" 
                class="edit-receta-btn text-sm font-medium text-fg-brand hover:underline flex items-center gap-1"
                data-receta={JSON.stringify(receta)}
              >
                <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" /></svg>
                Editar receta
              </button>
            </div>
          </div>
        </div>
      ))}
    </div>
  </section>
))}

<div id="receta-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 justify-center items-center w-full h-full bg-gray-900/50 backdrop-blur-sm">
  <div class="relative p-5 w-full max-w-2xl max-h-full">
      <div class="relative bg-neutral-primary-soft border border-default rounded-base shadow-lg overflow-hidden">
          <div class="flex items-center justify-between border-b border-default p-4 md:p-5">
              <h3 class="text-lg font-medium text-heading">Añadir nueva receta</h3>
              <button type="button" class="text-body hover:bg-neutral-tertiary rounded-base text-sm w-8 h-8 inline-flex justify-center items-center" data-modal-hide="receta-modal">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/></svg>
              </button>
          </div>

          <form action="/api/guardar-receta" method="post" class="p-6">
              <div class="grid gap-6 grid-cols-2">
                  <div class="col-span-2">
                      <label for="platillo" class="block mb-2 text-sm font-medium text-heading">Nombre de la receta</label>
                      <input type="text" id="platillo" name="platillo" class="bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base focus:ring-brand focus:border-brand block w-full p-2.5" placeholder="Ej: Pasta Carbonara" required>
                  </div>

                  <div class="col-span-2 md:col-span-1">      
                    <label class="block mb-2 text-sm font-medium text-heading">Ingredientes añadidos:</label>
                    <div class="min-h-[100px] p-3 border-2 border-dashed border-default-medium rounded-base bg-white/50">
                        <ul id="lista-visual" class="space-y-2"></ul>
                    </div>
                  </div>

                  <div class="col-span-2 md:col-span-1">
                      <label for="select-existente" class="block mb-2 text-sm font-medium text-heading">Elegir del catálogo:</label>
                      <select id="select-existente" class="block w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base mb-3">
                          <option value="" selected>Selecciona un ingrediente...</option>
                          {ingredientesDB?.map(i => <option value={i.nombre}>{i.nombre}</option>)}
                      </select>
                      <div class="text-right">
                        <button type="button" id="add-existente" disabled class="text-fg-disabled bg-disabled border border-default-medium font-medium rounded-base text-xs px-4 py-2 transition-all">
                            Añadir
                        </button>
                      </div>

                      <div id="accordion-nested" data-accordion="collapse" class="mt-4">
                        <h2 id="accordion-nested-heading">
                          <button type="button" class="flex items-center justify-between w-full p-3 text-xs font-medium border border-default rounded-base hover:bg-neutral-secondary-medium" data-accordion-target="#accordion-nested-body" aria-expanded="false">
                            <span>¿No está? Créalo aquí</span>
                            <svg data-accordion-icon class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="m5 15 7-7 7 7"/></svg>
                          </button>
                        </h2>
                        <div id="accordion-nested-body" class="hidden p-3 border border-t-0 border-default rounded-b-base bg-neutral-secondary-soft">
                          <div class="space-y-3">
                            <input type="text" id="n-nombre" class="w-full text-xs p-2 rounded border-default" placeholder="Nombre">
                            <input type="number" id="n-precio" class="w-full text-xs p-2 rounded border-default" placeholder="Precio ($)" step="0.01">
                            <select id="n-depto" class="w-full text-xs p-2 rounded border-default">
                                {departamentos.map(d => <option value={d}>{d}</option>)}
                            </select>
                            <select id="n-tienda" class="w-full text-xs p-2 rounded border-default">
                                {tiendas.map(t => <option value={t}>{t}</option>)}
                            </select>
                            <label class="flex items-center text-[10px] gap-2">
                                <input type="checkbox" id="n-porcionable" class="rounded"> ¿Es uno por comida?
                            </label>
                            <button type="button" id="add-nuevo" class="w-full bg-brand text-white text-xs py-2 rounded-base">Registrar y Añadir</button>
                          </div>
                        </div>
                      </div>
                  </div>

                  <div class="col-span-2 md:col-span-1">
                    <label class="block mb-2 text-sm font-medium text-heading">Link (YouTube/Web)</label>
                    <input type="url" name="link" class="bg-neutral-secondary-medium border border-default-medium rounded-base w-full p-2.5 text-sm" placeholder="https://...">
                  </div>
                  <div class="col-span-2 md:col-span-1">
                    <label class="block mb-2 text-sm font-medium text-heading">Nota adicional</label>
                    <textarea name="nota" rows="2" class="bg-neutral-secondary-medium border border-default-medium rounded-base w-full p-2.5 text-sm" placeholder="Opcional..."></textarea>
                  </div>
              </div>

              <div class="mt-8 border-t border-default pt-5 text-right">
                  <button type="submit" class="bg-brand text-white font-bold py-3 px-8 rounded-base hover:bg-brand-strong transition-colors">
                      Guardar Receta Final
                  </button>
              </div>
          </form>
          
      </div>
  </div>
</div>

<div id="edit-receta-modal" tabindex="-1" aria-hidden="true" class="hidden fixed inset-0 z-50 justify-center items-center w-full h-full bg-gray-900/50 backdrop-blur-sm">
  <div class="relative p-5 w-full max-w-2xl max-h-full">
      <div class="relative bg-neutral-primary-soft border border-default rounded-base shadow-lg overflow-hidden">
          <div class="flex items-center justify-between border-b border-default p-4 md:p-5">
              <h3 class="text-lg font-medium text-heading">Editar receta existente</h3>
              <button type="button" class="text-body hover:bg-neutral-tertiary rounded-base text-sm w-8 h-8 inline-flex justify-center items-center" data-modal-hide="edit-receta-modal">
                  <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/></svg>
              </button>
          </div>

          <form action="/api/actualizar-receta" method="post" class="p-6">
              <input type="hidden" name="id" id="up-receta-id">
              <div class="grid gap-6 grid-cols-2">
                  <div class="col-span-2">
                      <label class="block mb-2 text-sm font-medium text-heading">Nombre de la receta</label>
                      <input type="text" id="up-platillo" name="platillo" class="bg-neutral-secondary-medium border border-default-medium text-heading text-sm rounded-base w-full p-2.5 focus:ring-brand focus:border-brand" required>
                  </div>

                  <div class="col-span-2 md:col-span-1">      
                    <label class="block mb-2 text-sm font-medium text-heading">Ingredientes añadidos:</label>
                    <div class="min-h-[100px] p-3 border-2 border-dashed border-default-medium rounded-base bg-white/50">
                        <ul id="up-lista-visual" class="space-y-2"></ul>
                    </div>
                  </div>

                  <div class="col-span-2 md:col-span-1">
                      <label class="block mb-2 text-sm font-medium text-heading">Añadir del catálogo:</label>
                      <select id="up-select-existente" class="block w-full p-2.5 bg-neutral-secondary-medium border border-default-medium rounded-base mb-3 text-sm">
                          <option value="" selected>Selecciona un ingrediente...</option>
                          {ingredientesDB?.map(i => <option value={i.nombre}>{i.nombre}</option>)}
                      </select>
                      <div class="text-right">
                        <button type="button" id="up-add-existente" disabled class="text-fg-disabled bg-disabled border border-default-medium font-medium rounded-base text-xs px-4 py-2 transition-all">Añadir</button>
                      </div>

                      <div id="up-accordion-nested" data-accordion="collapse" class="mt-4">
                        <h2 id="up-accordion-nested-heading">
                          <button type="button" class="flex items-center justify-between w-full p-3 text-xs font-medium border border-default rounded-base hover:bg-neutral-secondary-medium" data-accordion-target="#up-accordion-nested-body" aria-expanded="false">
                            <span>¿Nuevo ingrediente? Créalo</span>
                            <svg data-accordion-icon class="w-4 h-4 shrink-0" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-width="2" d="m5 15 7-7 7 7"/></svg>
                          </button>
                        </h2>
                        <div id="up-accordion-nested-body" class="hidden p-3 border border-t-0 border-default rounded-b-base bg-neutral-secondary-soft">
                          <div class="space-y-3">
                            <input type="text" id="up-n-nombre" class="w-full text-xs p-2 rounded border-default" placeholder="Nombre">
                            <input type="number" id="up-n-precio" class="w-full text-xs p-2 rounded border-default" placeholder="Precio ($)" step="0.01">
                            <select id="up-n-depto" class="w-full text-xs p-2 rounded border-default">
                                {departamentos.map(d => <option value={d}>{d}</option>)}
                            </select>
                            <select id="up-n-tienda" class="w-full text-xs p-2 rounded border-default">
                                {tiendas.map(t => <option value={t}>{t}</option>)}
                            </select>
                            <label class="flex items-center text-[10px] gap-2">
                                <input type="checkbox" id="up-n-porcionable" class="rounded"> ¿Es uno por comida?
                            </label>
                            <button type="button" id="up-add-nuevo" class="w-full bg-brand text-white text-xs py-2 rounded-base">Registrar y Añadir</button>
                          </div>
                        </div>
                      </div>
                  </div>

                  <div class="col-span-2 md:col-span-1">
                    <label class="block mb-2 text-sm font-medium text-heading">Link (YouTube/Web)</label>
                    <input type="url" id="up-link" name="link" class="bg-neutral-secondary-medium border border-default-medium rounded-base w-full p-2.5 text-sm">
                  </div>
                  <div class="col-span-2 md:col-span-1">
                    <label class="block mb-2 text-sm font-medium text-heading">Nota adicional</label>
                    <textarea id="up-nota" name="nota" rows="2" class="bg-neutral-secondary-medium border border-default-medium rounded-base w-full p-2.5 text-sm"></textarea>
                  </div>
              </div>

              <div class="mt-8 border-t border-default pt-5 text-right">
                  <button type="submit" class="bg-brand text-white font-bold py-3 px-8 rounded-base hover:bg-brand-strong transition-colors shadow-lg">
                      Guardar Cambios
                  </button>
              </div>
          </form>
      </div>
  </div>
</div>

<div id="toast-success" class="z-[60] fixed bottom-20 right-5 flex items-center w-full max-w-xs p-4 text-gray-500 bg-white rounded-lg shadow-xl hidden transition-opacity duration-300" role="alert">
    <div class="inline-flex items-center justify-center shrink-0 w-8 h-8 text-green-500 bg-green-100 rounded-lg">
        <svg class="w-5 h-5" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 11.917 9.724 16.5 19 7.5"/></svg>
    </div>
    <div id="toast-message" class="ms-3 text-sm font-normal">Mensaje aquí</div>
</div>

<div class="fixed right-5 bottom-[10dvh]">
  <button data-modal-target="receta-modal" data-modal-toggle="receta-modal" class="text-white bg-brand hover:bg-brand-strong box-border border border-transparent focus:ring-4 focus:ring-brand-medium shadow-xl font-medium rounded-base text-base px-5 py-3 focus:outline-none flex" type="button">
    <span class="mr-3">Nueva receta</span>
    <svg class="w-6 h-6 text-gray-800 dark:text-white" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 12h14m-7 7V5"/></svg>
  </button>  
</div>


<script>
  import { initFlowbite } from 'flowbite';

  function setupRecipeLogic() {
    // --- LÓGICA COMPARTIDA ---
    function crearIngredienteVisual(nombre: string, esNuevo: boolean, contenedor: HTMLElement, data = {}) {
        const li = document.createElement('li');
        li.className = "flex items-center justify-between p-2 bg-white border border-default rounded-base group shadow-sm";
        li.innerHTML = `
            <div class="flex items-center gap-2">
                <svg class="w-3 h-3 text-green-500" fill="currentColor" viewBox="0 0 20 20"><path d="M10 .5a9.5 9.5 0 1 0 9.5 9.5A9.51 9.51 0 0 0 10 .5Zm3.707 8.207-4 4a1 1 0 0 1-1.414 0l-2-2a1 1 0 0 1 1.414-1.414L9 10.586l3.293-3.293a1 1 0 0 1 1.414 1.414Z"/></svg>
                <span class="text-xs font-medium text-heading">${nombre} ${esNuevo ? '<span class="text-[9px] text-brand uppercase font-bold">(Nuevo)</span>' : ''}</span>
                <input type="hidden" name="ingredientes_finales" value="${nombre}">
                ${esNuevo ? `<input type="hidden" name="nuevos_ingredientes_data" value='${JSON.stringify(data)}'>` : ''}
            </div>
            <button type="button" class="text-gray-300 hover:text-red-500 transition-colors remove-btn"><svg class="w-4 h-4" fill="none" viewBox="0 0 24 24"><path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18 17.94 6M18 18 6.06 6"/></svg></button>
        `;
        li.querySelector('.remove-btn')?.addEventListener('click', () => li.remove());
        contenedor.appendChild(li);
    }

    function toggleButtonState(select: HTMLSelectElement, button: HTMLButtonElement) {
        const active = ["text-white", "bg-brand", "hover:bg-brand-strong", "border-transparent"];
        const disabled = ["text-fg-disabled", "bg-disabled", "border-default-medium"];
        if (select.value !== "") {
            button.disabled = false;
            button.classList.remove(...disabled);
            button.classList.add(...active);
        } else {
            button.disabled = true;
            button.classList.remove(...active);
            button.classList.add(...disabled);
        }
    }

    // --- LÓGICA MODAL CREAR (Tus constantes actuales) ---
    // --- LÓGICA MODAL CREAR (Recuperada) ---
    const select = document.getElementById('select-existente') as HTMLSelectElement;
    const btnAddExistente = document.getElementById('add-existente') as HTMLButtonElement;
    const listaVisual = document.getElementById('lista-visual') as HTMLElement;

    // Validar select de crear para activar botón
    select?.addEventListener('change', () => toggleButtonState(select, btnAddExistente));

    // Botón para añadir ingrediente existente al CREAR
    btnAddExistente?.addEventListener('click', () => {
        if (select.value) {
            crearIngredienteVisual(select.value, false, listaVisual);
            select.value = "";
            toggleButtonState(select, btnAddExistente);
        }
    });

    // Botón para crear y añadir ingrediente nuevo al CREAR
    document.getElementById('add-nuevo')?.addEventListener('click', () => {
        const nom = document.getElementById('n-nombre') as HTMLInputElement;
        const pre = document.getElementById('n-precio') as HTMLInputElement;
        const dep = document.getElementById('n-depto') as HTMLSelectElement;
        const tie = document.getElementById('n-tienda') as HTMLSelectElement;
        const por = document.getElementById('n-porcionable') as HTMLInputElement;

        if (nom.value) {
            const data = { 
                nombre: nom.value, 
                precio: parseFloat(pre.value) || 0, 
                departamento: dep.value, 
                tienda: tie.value, 
                es_porcionable: por.checked 
            };
            
            crearIngredienteVisual(nom.value, true, listaVisual, data);
            
            // Feedback y limpieza
            const toast = document.getElementById('toast-success');
            if (toast) {
                document.getElementById('toast-message')!.textContent = "Ingrediente añadido";
                toast.classList.remove('hidden');
                setTimeout(() => toast.classList.add('hidden'), 2000);
            }

            // Limpiar campos y cerrar el acordeón de crear
            nom.value = ""; 
            pre.value = ""; 
            por.checked = false;
            document.querySelector('[data-accordion-target="#accordion-nested-body"]')?.dispatchEvent(new Event('click'));
        }
    });

    // --- LÓGICA MODAL EDITAR ---
    const upSelect = document.getElementById('up-select-existente') as HTMLSelectElement;
    const upBtnAdd = document.getElementById('up-add-existente') as HTMLButtonElement;
    const upLista = document.getElementById('up-lista-visual') as HTMLElement;

    upSelect?.addEventListener('change', () => toggleButtonState(upSelect, upBtnAdd));

    document.addEventListener('click', (e) => {
        const btn = (e.target as HTMLElement).closest('.edit-receta-btn');
        if (btn) {
            const data = JSON.parse((btn as HTMLElement).dataset.receta || '{}');
            (document.getElementById('up-receta-id') as HTMLInputElement).value = data.id;
            (document.getElementById('up-platillo') as HTMLInputElement).value = data.platillo;
            (document.getElementById('up-link') as HTMLInputElement).value = data.link || '';
            (document.getElementById('up-nota') as HTMLTextAreaElement).value = data.nota || '';
            upLista.innerHTML = '';
            data.ingredientes?.forEach((ing: string) => crearIngredienteVisual(ing, false, upLista));
        }
    });

    document.getElementById('up-add-existente')?.addEventListener('click', () => {
        if (upSelect.value) {
            crearIngredienteVisual(upSelect.value, false, upLista);
            upSelect.value = "";
            toggleButtonState(upSelect, upBtnAdd);
        }
    });

    document.getElementById('up-add-nuevo')?.addEventListener('click', () => {
        const nom = document.getElementById('up-n-nombre') as HTMLInputElement;
        const pre = document.getElementById('up-n-precio') as HTMLInputElement;
        const dep = document.getElementById('up-n-depto') as HTMLSelectElement;
        const tie = document.getElementById('up-n-tienda') as HTMLSelectElement;
        const por = document.getElementById('up-n-porcionable') as HTMLInputElement;

        if (nom.value) {
            const data = { nombre: nom.value, precio: parseFloat(pre.value) || 0, departamento: dep.value, tienda: tie.value, es_porcionable: por.checked };
            crearIngredienteVisual(nom.value, true, upLista, data);
            nom.value = ""; pre.value = "";
            document.querySelector('[data-accordion-target="#up-accordion-nested-body"]')?.dispatchEvent(new Event('click'));
        }
    });
  }

document.addEventListener('astro:page-load', () => {
  const hash = window.location.hash;
  if (hash) {
    const target = document.querySelector(hash);
    if (target) {
      // Simulamos un click en el botón del acordeón para que Flowbite lo abra
      setTimeout(() => target.click(), 500); 
    }
  }
});

  document.addEventListener('astro:page-load', () => {
    initFlowbite();
    setupRecipeLogic();
  });
</script>

</Layout>